# 测试结论

> - kops-agent云主机监控数据优化后准确度
> - cpu时间片总量，内存总量，磁盘读写总量，网卡读写总量的数据精度达到百万分之一
> - cpu利用率精度千分之一，内存利用率，磁盘，网卡读写速率精度达到万分之一

## 测试难点

### agent与其他测试工具的时间同步问题

> - 手动同步(200ms)
> - shell脚本（50ms，ssh受网络环境影响）
> - go定时器(程序启动误差100纳秒以内，数据获取时间误差3ms左右)

### 云主机磁盘总量及磁盘读写速率的测试方法问题

> - agent需要对多款监控工具比较数据
> - 监控工具精度不够
> - 云主机磁盘总量与读写速率测试工具没有现成的，要自己造轮子。
> - 云主机的磁盘相关信息是相对宿主机而言的，并非是云主机内部的。所以市面上的磁盘io监控工具都无法使用。

### 数据分析工具问题

> - agent采集的数据写入文件，在以用sed，awk，cut等工具分离出目标数据
> - 将目标数据导入到excel，生成分析图表

## 测试过程

所有的测试数据都在附件的excel表中，手动同步与shell同步的测试数据就不在此描述了。
将agent与测试工具外面，包装一层go的定时器，go语言的时间戳精度可达到纳秒级别。
测试过程中，程序启动误差100纳秒以内，数据获取时间误差3ms左右

所有的测试数据及图表，都已上传至seafile

[http://seafile.kylincloud.me:8000/smart-link/e2e58fa0-c235-4d3a-be0e-ba95e1717217/](http://seafile.kylincloud.me:8000/smart-link/e2e58fa0-c235-4d3a-be0e-ba95e1717217/)


着重介绍一下磁盘，网络读写速率的优化

### 优化前

#### 网络读写速率

```
InstanceName :  instance-chenjiahua
时间点               上传(KB/s)                  下载(MB/s)
             sar      kops      误差率     sar     kops     误差率
15:04:50     273.37   273.37    0.00%     53.31   53.31    0.00%
15:05:20     235.67   243.81    3.34%     37.41   38.70    3.46%
15:05:50     216.00   216.00    0.00%     27.42   27.42    0.00%
15:06:20     169.66   175.50    3.33%     19.10   19.75    3.44%
15:06:50     169.32   169.33    0.00%     17.96   17.96    0.01%
15:07:20     184.95   184.96    0.01%     19.47   19.47    0.01%
15:07:50     194.34   201.04    3.33%     19.16   19.82    3.45%
15:08:20     202.54   209.50    3.32%     23.48   24.28    3.43%
15:08:50     210.26   210.27    0.01%     24.98   24.98    0.01%
15:09:20     210.11   217.36    3.34%     25.56   26.44    3.45%
15:09:50     192.24   198.86    3.33%     21.74   22.49    3.44%
15:10:20     198.23   198.24    0.00%     21.94   21.94    0.00%
15:10:50     183.24   189.56    3.34%     20.94   21.66    3.45%
15:11:20     180.37   186.59    3.33%     20.22   20.92    3.45%
15:11:50     215.45   215.45    0.00%     26.36   26.36    0.00%
15:12:20     202.81   202.78    0.01%     21.61   21.61    0.03%
15:12:50     191.50   198.09    3.33%     21.42   22.16    3.47%
15:13:20     167.94   167.99    0.03%     17.18   17.18    0.01%
15:13:50     177.13   177.13    0.00%     18.85   18.85    0.00%
15:14:20     219.32   219.32    0.00%     24.72   24.72    0.00%
15:14:50     186.61   193.03    3.33%     20.31   21.01    3.44%
15:15:20     153.61   158.92    3.34%     16.26   16.82    3.46%
15:15:50     81.51    81.51     0.00%      9.47    9.47    0.01%
avg                             1.60%                      1.65%

```

### 磁盘读写速率

```
InstanceName :  instance-chenjiahua
时间点              读(MB/s)                        写(MB/s)
            virsh       kops        误差率     virsh    kops        误差率
20:31:30    23.8451     23.0503     3.4483%   92.7246   89.6337     3.448%
20:32:00    20.0000     20.0000     0.0000%   93.7417   93.7417     0.000%
20:32:30    23.8667     24.6897     3.3333%   95.3170   98.4831     3.215%
20:33:00    19.8831     20.5687     3.3333%   96.2672   99.6557     3.400%
20:33:30    19.6202     18.9661     3.4483%   98.6046   95.3677     3.394%
20:34:00    18.8021     19.4504     3.3333%   98.1874   101.5732    3.333%
20:34:30    20.2228     19.5487     3.4483%   97.2725   93.9634     3.522%
20:35:00    19.7333     20.4138     3.3333%   93.4840   96.7076     3.333%
20:35:30    18.3618     18.2260     0.7450%   99.6898   99.7243     0.035%
20:36:00    24.8785     24.1805     2.8868%   100.5349  97.2171     3.413%
20:36:30    23.5183     23.5183     0.0000%   96.3970   96.3970     0.000%
20:37:00    20.5331     20.5331     0.0000%   93.9676   93.9676     0.000%
20:37:30    22.6207     21.8503     3.5259%   100.0347  96.5668     3.591%
20:38:00    22.9169     22.8000     0.5128%   94.1840   94.3173     0.141%
20:38:30    21.0164     20.4492     2.7738%   98.2244   94.9503     3.448%
20:39:00    19.8174     20.3650     2.6888%   88.7676   91.7423     3.242%
20:39:30    20.5517     20.6875     0.6563%   93.9656   93.8974     0.073%
20:40:00    21.0667     21.7931     3.3333%   93.3004   96.5341     3.350%
20:40:30    21.0469     21.0469     0.0000%   98.2261   98.3295     0.105%
20:41:00    19.7333     19.7333     0.0000%   94.0029   94.0362     0.035%
20:41:30    22.6339     22.6339     0.0000%   95.1001   94.7671     0.351%
avg                                 1.9429%                         1.973%
```

误差分析很明显，磁盘网络速率误差均在0%与3.3%来回跳转，磁盘网络的总量值获取是非常准确的，那么问题只能出在时间间隔上。

通过定位kops-agent代码，很快就找到了问题所在。
```
DiskinBits := float64(rRdBytes-oldStat.inBytes) / float64(interval/1e9)
```

磁盘读速率的表达式，其中interval为时间间隔，是一个int64类型，单位是纳秒(1s = 1e9纳秒)
interval/1e9这个表达式可能会损失1s的精度，例如，两次统计的时间分别为1617334620000255134，1617334650000204797
相差29999949568纳秒，除以1e9,换算成秒后应该为29.999949568秒，但是int64除法，结果为29秒

这样一来，30s的时间间隔变为29秒，误差为1/30，正好为3.3%


### 优化后

```
DiskinBits := (float64(rRdBytes-oldStat.inBytes) / float64(interval)) * 1e9
```

### 磁盘读写速率

```
InstanceName :  instance-chenjiahua
时间点		    读速率(MB/s)		          写速率(MB/s)             读总量(MB)	                         写总量(MB)
		  virsh	    kops	误差率	  virsh		 kops	误差率	   virsh		kops		  误差率	virsh		  kops		  误差率
11:23:30  18.1409  18.1416  0.0037%	  79.3502 	79.3826  0.0408% 472241.0859  472239.0547	0.00043%  646220.7305	646220.7305	0.00000%
11:24:00  16.6664  16.7340  0.4057%	  79.9158 	79.9154  0.0006% 472741.0859  472741.0859	0.00000%  648618.2432	648618.2432	0.00000%
11:24:30  17.8690  17.8698  0.0047%	  83.7682 	83.7388  0.0351% 473277.1484  473277.1484	0.00000%  651131.2544	651130.2544	0.00015%
11:25:00  18.8985  18.8799  0.0983%	  80.1842 	80.2172  0.0411% 473844.1016  473843.5469	0.00012%  653536.7759	653536.7759	0.00000%
11:25:30  17.2321  17.2467  0.0850%	  87.2294 	87.2100  0.0223% 474361.0859  474361.0859	0.00000%  656153.7725	656153.7725	0.00000%
11:26:00  21.2492  21.2549  0.0267%	  87.0352 	86.9571  0.0898% 474998.5625  474998.5625	0.00000%  658764.8315	658761.7925	0.00046%
11:26:30  19.4178  19.4168  0.0052%	  87.7843 	87.6477  0.1556% 475581.0859  475581.0859	0.00000%  661398.3081	661391.3081	0.00106%
11:27:00  21.0848  21.0855  0.0030%	  92.2328 	92.4689  0.2560% 476213.6406  476213.6406	0.00000%  664165.3335	664165.3335	0.00000%
11:27:30  18.1142  18.1149  0.0039%	  87.5474 	87.5508  0.0039% 476757.0859  476757.0859	0.00000%  666791.8486	666791.8486	0.00000%
11:28:00  18.8351  18.8255  0.0511%	  88.9677 	88.9222  0.0511% 477322.1328  477322.1328	0.00000%  669460.8506	669460.8506	0.00000%
11:28:30  21.8353  21.8443  0.0410%	  86.2240 	86.2594  0.0410% 477977.1406  477977.1406	0.00000%  672047.3711	672047.3711	0.00000%
11:29:00  18.9317  18.9331  0.0075%	  89.3792 	89.3858  0.0075% 478545.1211  478545.1211	0.00000%  674728.8911	674728.8911	0.00000%
11:29:30  21.3671  21.3662  0.0044%	  94.6382 	94.6174  0.0220% 479186.1055  479186.1055	0.00000%  677567.9028	677567.4028	0.00007%
11:30:00  19.9524  19.9527  0.0012%	  91.8149 	91.8327  0.0194% 479784.6914  479784.6914	0.00000%  680322.4126	680322.4126	0.00000%
11:30:30  17.3525  17.3526  0.0006%	  86.3674 	86.3680  0.0006% 480305.2695  480305.2695	0.00000%  682913.4463	682913.4463	0.00000%
11:31:00  18.1337  18.1210  0.0700%	  88.0050 	87.9601  0.0511% 480849.2695  480849.2695	0.00000%  685553.5459	685554.0459	0.00007%
11:31:30  19.7162  19.7305  0.0722%	  91.8150 	91.8647  0.0541% 481440.7773  481440.7773	0.00000%  688308.0938	688308.0938	0.00000%
11:32:00  17.1187  17.1061  0.0737%	  88.9040 	88.8385  0.0737% 481954.3164  481954.3164	0.00000%  690975.0981	690975.0981	0.00000%
11:32:30  19.1479  19.1619  0.0730%	  83.9271 	83.7551  0.2049% 482528.7773  482528.7773	0.00000%  693493.0166	693486.0244	0.00101%
11:33:00  21.3338  21.3335  0.0017%	  86.7392 	86.9708  0.2670% 483168.7773  483168.7773	0.00000%  696095.1309	696095.1309	0.00000%
11:33:30  20.1489  20.1494  0.0023%	  90.5806 	90.5827  0.0023% 483773.2695  483773.2695	0.00000%  698812.6592	698812.6592	0.00000%
11:34:00  17.7508  17.7497  0.0059%	  85.9706 	85.9655  0.0059% 484305.7617  484305.7617	0.00000%  701391.6294	701391.6294	0.00000%
11:34:30  20.7667  20.7675  0.0035%	  88.5166 	88.5196  0.0035% 484928.7773  484928.7773	0.00000%  704047.1831	704047.1831	0.00000%
11:35:00  17.3334  17.3335  0.0009%	  88.6340 	88.6348  0.0009% 485448.7773  485448.7773	0.00000%  706706.1953	706706.1953	0.00000%
11:35:30  21.2182  21.2183  0.0008%	  89.1487 	89.1494  0.0008% 486085.332	  486085.332	0.00000%  09380.6992	709380.6992	0.00000%
11:36:00  18.9154  18.8139  0.5365%	  91.0360 	90.9980  0.0417% 486652.7773  486649.7617	0.00062%  712111.7007	712110.7007	0.00014%
11:36:30  22.1333  22.2342  0.4556%	  91.9507 	91.9853  0.0377% 487316.7773  487316.7773	0.00000%  714870.2207	714870.2207	0.00000%
11:37:00  17.5999  17.5997  0.0013%	  91.6125 	91.6113  0.0013% 487844.7773  487844.7773	0.00000%  717618.6074	717618.6074	0.00000%
avg			                0.0728%			             0.0547%			                0.00004%			                0.00011%
```


优化过后，磁盘读写速率精度达到了万分之几，偶尔的千分之几的误差要么是总量波动的影响，要么是时间间隔波动的影响(数据中体现不出来，但在测试过程中，偶尔时间波动会达到几十至几百毫秒，此时精度会降低到千分之几)。









