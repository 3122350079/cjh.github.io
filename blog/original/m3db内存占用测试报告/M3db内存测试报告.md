
# m3db内存占用大小测试

## 未接入数据

### 集群版

#### (单节点)

>  m3db环境node1：172.20.42.15

>  x86 centos7 4核8G

> - 服务起来
>   - 内存 800G左右（资源池占用了450M内存）
> - 环境配置好
>   - 内存 2.7G左右


#### (多节点）

> - m3db环境node1：172.20.42.15
> - m3db环境node2：172.20.42.16
> - m3db环境node3：172.20.42.17
> - x86 centos7 4核8G
> - 服务起来
>   - node1内存 1.3G左右
>   - node2内存 1.3G左右
>   - node3内存 1.3G左右
> - 环境配置好
>   - node1内存 3.4G左右
>   - node2内存 3.4G左右
>   - node3内存 3.4G左右

### 单机版

>  m3db环境local：172.20.42.13

>  x86 centos7 4核8G

> - 服务起来:
> - 内存占用  700M左右
> - 环境配置好:
> - 内存占用  1.7G左右

### 服务自生所占用内存大小的影响因素

#### 集群版 (单节点)

>  m3db环境node0：172.20.42.14

>  x86 centos7 4核8G

服务起来

内存占用 800M左右

通过go pprof可视化工具分析
```
pool init                   450M左右
check new server            100M左右
encodeing and decodeing     50M左右
Bootstrapper                50M左右
new other                   150M左右
```

由此可见，影响内存占用的最大因素是pool(资源池)

由于encodeing，decodeing，bootstrapper等因素官方强烈建议使用默认配置

故目前只讨论pool对内存的影响

根据m3db配置相关代码可得pool的三方面参数为
```
1.size
2.capacity
3.refillHighWaterMark,refillLowWaterMark(高低水位线)
```
#### 资源池对服务自身内存占用影响

> 环境：集群单节点 node0：172.20.42.14
> x86 centos7 4核8G

pool size与capacity 对内存的影响

由于m3db有非常多种类的pool，每种pool之间的最佳配比需要理论和大量的测试才能得出结论。

目前测试是在默认配置的基础上，各个pool的size，capacity成比例的缩减，来测试pool对内存的影响。

```
       默认配置的倍数                   服务起来占用的内存        数据库配置好的内存
       size    capacity                         size                      size
(对照)  1           1                           830M                      2.7G

(实验)  1           1/2                         783M                      2.4G
(实验)  1           1/4                         784M                      2.2G
(实验)  1           1/8                         816M                      2.5G
 
(实验)  1/2         1                           630M                      2.6G
(实验)  1/2         1/2                         632M                      2.4G
(实验)  1/2         1/4                         613M                      2.1G
(实验)  1/2         1/8                         634M                      1.9G

(实验)  1/4         1                           551M                      2.5G
(实验)  1/4         1/2                         552M                      2.2G
(实验)  1/4         1/4                         543M                      1.9G
(实验)  1/4         1/8                         543M                      1.8G

(实验)  1/8         1                           549M                      1.8G
(实验)  1/8         1/2                         483M                      1.7G
(实验)  1/8         1/4                         481M                      1.3G
(实验)  1/8         1/8                         497M                      2.2G

(实验)  1/16        1                           477M                      2.1G
(实验)  1/16        1/2                         475M                      1.7G
(实验)  1/16        1/4                         474M                      1.7G
(实验)  1/16        1/8                         473M                      1.7G
```

> - 不同环境下测试数据可能会有所偏差

实验结论:

size，capacity都不是越小越好，原因是size太大(资源浪费)或者太小(频繁加油)都会导致内存占用变大

size为默认配置的1/8，capacity为默认1/4时，数据库配置好的内存最低，为1.4G


#### pool 高低水位线对内存影响

```
size，capacity倍数为1倍  1.0 > 高水位线 > 0.5 > 低水位线 > 0.0

        高水位线        低水位线            服务起来占用的内存			数据库配置好的内存
(对照)      0.6             0.3                  825M                       2.7G

低水位线 
(实验)      0.6             0.5                  848M                       2.8G
(实验)      0.6             0.4                  828M                       2.7G
(实验)      0.6             0.2                  837M                       2.7G
(实验)      0.6             0.1                  837M                       2.7G

高水位线
(实验)      0.7             0.3                  836M                       2.7G
(实验)      0.8             0.3                  814M                       2.0G
(实验)      0.9             0.3                  815M                       2.0G

高低水位差
(实验)      0.7             0.4                  825M                        2.5G
(实验)      0.7             0.3                  800M                        1.9G
(实验)      0.7             0.2                  802M                        1.7G

(实验)      0.8             0.4                  814M                        2.6G                        
(实验)      0.8             0.3                  814M                        2.0G
(实验)      0.8             0.2                  806M                        1.7G
(实验)      0.8             0.1                  843M                        2.4G

(实验)      0.9             0.4                  849M                        2.5G
(实验)      0.9             0.3                  859M                        2.6G
(实验)      0.9             0.2                  874M                        2.6G
(实验)      0.9             0.1                  853M                        2.5G


```
实验结论：
低水位线与高水位线的单纯数值与内存占用关系不大。
高低水位线差对内存的影响大，建议高水位线0.7-0.8区间，低水位线0.2-0.3
```

```
## 接入数据
### 缓存策略对于内存影响
> - 自身前后对照(除了缓存策略  其他配置均一致)

四种缓存策略

```
1.All Cache Policy
m3db保存的所有的数据都在内存中,适用于数据量小，读取数据频繁，性能要求高的场景

2.None Cache Policy
m3db保存的所有的数据都在磁盘上,适用于性能要求低，数据量大的场景

3.Recently Read Cache Policy
m3db将最近的blockSize大小的数据完整的保存在缓存中，适用于频繁读取最近一段时间数据的场景，比如数据库支持自动警报的情况

4.Least Recently Used (LRU) Cache Policy
m3db将最近的blockSize大小的数据中读取最少的一部分驱逐出内存，写入磁盘。对于一般用途的工作负载，建议使用lru缓存策略。
```


lru缓存策略
```
环境：集群单节点 node0：172.20.42.14
x86 centos7 4核8G
数据保存在缓存中24小时

0小时   2.1G		

12小时	2.2G

```
none缓存策略 
```
环境：集群单节点 node1：172.20.42.15
x86 centos7 4核8G
数据保存在缓存中24小时

0小时   2.1G		

12小时	2.1G

```
all缓存策略
```
环境：集群单节点 node2：172.20.42.16
x86 centos7 4核8G
数据保存在缓存中24小时

0小时   2.1G			

12小时	2.3G

```
recently_read缓存策略
```
环境：集群单节点 node3：172.20.42.17
x86 centos7 4核8G
数据保存在缓存中24小时

0小时   2.1G			

12小时	2.2G

```
由于数据量只有一个agent每30s push次数据，对于m3dn而言，没有负载压力，所以内存变化较小。
还是可以看出 all > recently_read > lru > none
没有特殊需求，缓存策略一般选择lru策略
后面还需做高并发测试，增加m3db负载读写压力，测试缓存策略对内存的影响。


### 动态资源限制对于内存影响

测试结果影响很小，建议增加m3db读写请求压力，提高内存分析工具的单位精度，在测试动态资源限制对内存的影响。

### blockSizeTime对于内存影响

blockSizeTime 是设定数据在内存的时间

>  自身前后对照(除了blockSizeTime  其他配置均一致)

环境：集群单节点 compare：172.20.42.13

x86 centos7 4核16G

capacity 1/4, size 1/8
```
blockSizeTime大小		服务起来的内存		数据库配置好的内存	
30m							497M				1.4G

1h							520M				1.5G							

2h							521M				1.7G

4h							519M				2.0G				

6h							522M				2.1G	

8h							522M				2.1G

10h							522M				2.1G
```
blockSizeTime越大占用内存越大，不过在未接入数据前blockSizeTime影响会饱和。
blockSizeTime的确定要根据需求来确定。

## 结论

```
m3db自身服务对内存影响因素：
主要因素资源池：
1.size
2.capacity
3.高低水位线

m3db数据对内存影响的因素：
1.blockSizeTime大小
2.缓存策略（目前是lru缓存）
3.动态资源限制（限制读写请求,更改无需重启服务）(待测)
```

size和capacity配置太大(资源浪费)或者太小(频繁加油)都会导致内存占用变大,建议size为默认配置的1/8，capacity为默认1/4.

高低水位线差对内存的影响大，建议高水位线0.7-0.8区间，低水位线0.2-0.3

本次测试数据对内存影响不大，主要原因测试环境是数据量不大，没有对m3db server端造成读写压力。vv

官方建议正常情况下内存利用率不超过50%~60%

